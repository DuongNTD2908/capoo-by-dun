const chapter1Questions = [
    {
        type: "multiple",
        question: "What is the synonym of 'happy'?",
        options: ["Sad", "Joyful", "Angry", "Tired"],
        answer: "Joyful",
    },
    {
        type: "fill",
        question: "She ___ to school every day.",
        answer: "goes",
    },
    {
        type: "multiple",
        question: "What color is the sky on a clear day?",
        options: ["Green", "Blue", "Red", "Black"],
        answer: "Blue",
    },
    {
        type: "fill",
        question: "I ___ a book yesterday.",
        answer: "read",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["go", "I", "to", "school", "every", "day"],
        answer: "I go to school every day",
    },
];
const chapter2Questions = [
    {
        type: "multiple",
        question: "Which animal barks?",
        options: ["Cat", "Dog", "Bird", "Fish"],
        answer: "Dog",
    },
    {
        type: "fill",
        question: "I always ___ breakfast at 7am.",
        answer: "eat",
        answer: "have",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["She", "is", "reading", "a", "book"],
        answer: "She is reading a book",
    },
    {
        type: "multiple",
        question: "What is the antonym of 'hot'?",
        options: ["Cold", "Warm", "Boil", "Spicy"],
        answer: "Cold",
    },
    {
        type: "fill",
        question: "They ___ in the park yesterday.",
        answer: "walked",
    },
];
const chapter3Questions = [
    {
        type: "multiple",
        question: "Which one is a fruit?",
        options: ["Carrot", "Potato", "Banana", "Lettuce"],
        answer: "Banana",
    },
    {
        type: "fill",
        question: "He ___ very tall.",
        answer: "is",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["My", "name", "is", "Anna"],
        answer: "My name is Anna",
    },
    {
        type: "multiple",
        question: "What is the past tense of 'go'?",
        options: ["goed", "gone", "goes", "went"],
        answer: "went",
    },
    {
        type: "fill",
        question: "The sun ___ in the east.",
        answer: "rises",
    },
];
const chapter4Questions = [
    {
        type: "multiple",
        question: "How many legs does a spider have?",
        options: ["6", "8", "10", "12"],
        answer: "8",
    },
    {
        type: "fill",
        question: "The cake ___ delicious.",
        answer: "is",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["We", "are", "playing", "football", "now"],
        answer: "We are playing football now",
    },
    {
        type: "fill",
        question: "Tom ___ a letter yesterday.",
        answer: "wrote",
    },
    {
        type: "multiple",
        question: "What is the plural of 'mouse'?",
        options: ["Mouses", "Mices", "Mouse", "Mice"],
        answer: "Mice",
    },
];
const chapter5Questions = [
    {
        type: "multiple",
        question: "What is the opposite of 'early'?",
        options: ["Late", "Quick", "Slow", "Fast"],
        answer: "Late",
    },
    {
        type: "fill",
        question: "She ___ to music every evening.",
        answer: "listens",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["He", "has", "a", "new", "bike"],
        answer: "He has a new bike",
    },
    {
        type: "fill",
        question: "We ___ a big house.",
        answer: "have",
    },
    {
        type: "multiple",
        question: "Which season is the coldest?",
        options: ["Spring", "Autumn", "Winter", "Summer"],
        answer: "Winter",
    },
];
const chapter6Questions = [
    {
        type: "fill",
        question: "She ___ tea every morning.",
        answer: "drinks",
    },
    {
        type: "multiple",
        question: "Which is a color?",
        options: ["Chair", "Blue", "Pen", "Phone"],
        answer: "Blue",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["It", "is", "a", "beautiful", "day"],
        answer: "It is a beautiful day",
    },
    {
        type: "fill",
        question: "I ___ a student.",
        answer: "am",
    },
    {
        type: "multiple",
        question: "What comes after 'Monday'?",
        options: ["Sunday", "Friday", "Tuesday", "Wednesday"],
        answer: "Tuesday",
    },
];
const chapter7Questions = [
    {
        type: "multiple",
        question: "What do bees make?",
        options: ["Milk", "Butter", "Honey", "Sugar"],
        answer: "Honey",
    },
    {
        type: "fill",
        question: "My dad ___ a doctor.",
        answer: "is",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["The", "dog", "is", "very", "cute"],
        answer: "The dog is very cute",
    },
    {
        type: "fill",
        question: "I ___ pizza last night.",
        answer: "ate",
    },
    {
        type: "multiple",
        question: "Which is a vegetable?",
        options: ["Apple", "Carrot", "Orange", "Banana"],
        answer: "Carrot",
    },
];
const chapter8Questions = [
    {
        type: "multiple",
        question: "Which planet do we live on?",
        options: ["Mars", "Venus", "Earth", "Jupiter"],
        answer: "Earth",
    },
    {
        type: "fill",
        question: "Birds ___ in the sky.",
        answer: "fly",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["I", "love", "playing", "the", "guitar"],
        answer: "I love playing the guitar",
    },
    {
        type: "fill",
        question: "He ___ to the market yesterday.",
        answer: "went",
    },
    {
        type: "multiple",
        question: "What color is a ripe banana?",
        options: ["Green", "Red", "Yellow", "Blue"],
        answer: "Yellow",
    },
];
const chapter9Questions = [
    {
        type: "multiple",
        question: "What sound does a cat make?",
        options: ["Woof", "Moo", "Meow", "Quack"],
        answer: "Meow",
    },
    {
        type: "fill",
        question: "My mom ___ good food.",
        answer: "cooks",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["He", "is", "watching", "a", "movie"],
        answer: "He is watching a movie",
    },
    {
        type: "fill",
        question: "We ___ soccer on Sundays.",
        answer: "play",
    },
    {
        type: "multiple",
        question: "What do cows produce?",
        options: ["Eggs", "Milk", "Juice", "Wool"],
        answer: "Milk",
    },
];
const chapter10Questions = [
    {
        type: "multiple",
        question: "Which one is a drink?",
        options: ["Bread", "Juice", "Rice", "Apple"],
        answer: "Juice",
    },
    {
        type: "fill",
        question: "My sister ___ in grade 5.",
        answer: "is",
    },
    {
        type: "reorder",
        question: "Sắp xếp từ thành câu hoàn chỉnh:",
        words: ["I", "am", "learning", "English", "now"],
        answer: "I am learning English now",
    },
    {
        type: "fill",
        question: "He ___ a new phone last week.",
        answer: "bought",
    },
    {
        type: "multiple",
        question: "Which is used to write?",
        options: ["Eraser", "Ruler", "Pen", "Bag"],
        answer: "Pen",
    },
];

let currentQuestionIndex = 0;
let currentChapter = [];
const container = document.getElementById("question-container");
const popup = document.getElementById("popup");
const feedback = document.getElementById("feedback");

// document.addEventListener("DOMContentLoaded", () => {
//     moveNowToCurrentChapter();
// });
function startChapter(questions) {
    currentChapter = questions;
    currentQuestionIndex = 0;
    feedback.textContent = "";
    feedback.classList.remove("wrong");
    document.getElementById("popup-wrapper").classList.remove("hidden");
    showQuestion();
    document.getElementById("popup").classList.remove("hidden");
}
document.querySelectorAll(".inner-button").forEach((btn) => {
    btn.addEventListener("click", () => {
        if (btn.classList.contains("done")) {
            showReplayConfirm(() => {
                startChapter(getQuestionsFor(btn.id));
            });
        } else if (btn.classList.contains("now-chapter")) {
            startChapter(getQuestionsFor(btn.id));
        }
    });
});
function getQuestionsFor(id) {
    const map = {
        chapter1: chapter1Questions,
        chapter2: chapter2Questions,
        chapter3: chapter3Questions,
        chapter4: chapter4Questions,
        chapter5: chapter5Questions,
        chapter6: chapter6Questions,
        chapter7: chapter7Questions,
        chapter8: chapter8Questions,
        chapter9: chapter9Questions,
        chapter10: chapter10Questions,
    };
    return map[id];
}

function showQuestion() {
    const q = currentChapter[currentQuestionIndex];
    container.innerHTML = "";
    feedback.textContent = "";
    feedback.classList.remove("wrong");

    const div = document.createElement("div");

    if (q.type === "multiple") {
        div.innerHTML = `<p><strong>Câu ${currentQuestionIndex + 1}:</strong> ${
            q.question
        }</p>`;
        const optionsDiv = document.createElement("div");
        optionsDiv.className = "options";
        q.options.forEach((opt) => {
            const btn = document.createElement("button");
            btn.textContent = opt;
            btn.className = "choice-btn";
            btn.addEventListener("click", () => {
                // Bỏ chọn các nút khác
                document
                    .querySelectorAll(".choice-btn")
                    .forEach((b) => b.classList.remove("selected"));
                btn.classList.add("selected");
                btn.setAttribute("data-selected", "true");
                feedback.textContent = "";
            });
            optionsDiv.appendChild(btn);
        });
        div.appendChild(optionsDiv);
    } else if (q.type === "fill") {
        div.innerHTML = `<p><strong>Câu ${currentQuestionIndex + 1}:</strong> ${
            q.question
        }</p>
      <input type="text" id="fill-answer" placeholder="Your answer">`;
    } else if (q.type === "match") {
        div.innerHTML = `<p><strong>Câu ${currentQuestionIndex + 1}:</strong> ${
            q.question
        }</p>`;
        const leftItems = q.pairs
            .map((p, i) => `<div>${i + 1}. ${p.left}</div>`)
            .join("");
        const rightItems = q.pairs
            .map((p) => p.right)
            .sort(() => 0.5 - Math.random())
            .map(
                (item, i) =>
                    `<div>${String.fromCharCode(65 + i)}. ${item}</div>`
            )
            .join("");
        div.innerHTML += `
      <div style="display: flex; gap: 40px;">
        <div>${leftItems}</div>
        <div>${rightItems}</div>
      </div>
      <p>Ví dụ nhập: 1-A, 2-B</p>
      <input type="text" id="match-answer" placeholder="Nhập đáp án">`;
    } else if (q.type === "reorder") {
        div.innerHTML = `<p><strong>Câu ${currentQuestionIndex + 1}:</strong> ${
            q.question
        }</p>
    <div id="word-buttons" style="margin-bottom:10px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
    <p>Kết quả của bạn:</p>
    <div id="your-answer" style="min-height:32px; display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
    <button style="padding: 5px; border-radius: 6px; border: 1px solid; position: relative; z-index: 20;" onclick="clearReorderAnswer()">Xóa lựa chọn</button>
  `;

        const shuffled = [...q.words].sort(() => 0.5 - Math.random());
        const wordButtons = div.querySelector("#word-buttons");
        const yourAnswer = div.querySelector("#your-answer");

        shuffled.forEach((word) => {
            const btn = document.createElement("button");
            btn.textContent = word;
            btn.className = "reorder-btn";
            btn.dataset.word = word;
            btn.addEventListener("click", () =>
                moveWord(btn, yourAnswer, wordButtons)
            );
            wordButtons.appendChild(btn);
        });
    }

    container.appendChild(div);
}

function checkAnswer() {
    const q = currentChapter[currentQuestionIndex];
    let isCorrect = false;

    if (q.type === "multiple") {
        const selectedBtn = document.querySelector(".choice-btn.selected");
        if (!selectedBtn) {
            feedback.textContent = "Vui lòng chọn một đáp án!";
            feedback.classList.add("wrong");
            return;
        }
        isCorrect = selectedBtn.textContent.trim() === q.answer;
    } else if (q.type === "fill") {
        const input = document.getElementById("fill-answer");
        if (!input.value) {
            feedback.textContent = "Hãy điền đáp án!";
            feedback.classList.add("wrong");
            return;
        }
        isCorrect = input.value.trim().toLowerCase() === q.answer.toLowerCase();
    } else if (q.type === "match") {
        const input = document
            .getElementById("match-answer")
            .value.trim()
            .toUpperCase();
        const expected = ["1-A", "2-B"];
        isCorrect = expected.every((pair) => input.includes(pair));
    } else if (q.type === "reorder") {
        const selectedWords = [
            ...document
                .getElementById("your-answer")
                .querySelectorAll("button"),
        ].map((btn) => btn.textContent.trim());
        const answer = selectedWords.join(" ");
        isCorrect = answer === q.answer;
    }

    if (isCorrect) {
        feedback.textContent = "Chính xác!";
        feedback.classList.remove("wrong");
        currentQuestionIndex++;

        if (currentQuestionIndex < currentChapter.length) {
            setTimeout(showQuestion, 1000);
        } else {
            setTimeout(() => {
                const element = document.getElementById("now");

                popup.classList.add("hidden");
                document
                    .getElementById("popup-wrapper")
                    .classList.add("hidden");
                alert("Hoàn thành chương!");
                moveNowToCurrentChapter();

                const currentChapterBtn = document.querySelector(
                    ".inner-button.now-chapter"
                );

                if (currentChapterBtn) {
                    const currentId = currentChapterBtn.id;
                    const currentNum = parseInt(
                        currentId.replace("chapter", "")
                    );
                    currentChapterBtn.classList.add("done");
                    currentChapterBtn.classList.remove("now-chapter");
                    saveProgress(currentId);

                    const nextNum = currentNum + 1;
                    const nextBtn = document.getElementById(
                        "chapter" + nextNum
                    );

                    if (nextBtn) {
                        nextBtn.classList.add("now-chapter");
                        moveNowToCurrentChapter(); // <-- Gọi ở đây, sau khi gán class
                    } else {
                        const completePopup =
                            document.getElementById("complete-popup");
                        completePopup.classList.remove("hidden");
                        element.style.display = "none";
                        launchConfetti();
                    }
                }
            }, 1000);
        }
    } else {
        feedback.textContent = "Sai rồi, hãy thử lại nhé!";
        feedback.classList.add("wrong");
    }
}
function clearReorderAnswer() {
    const yourAnswer = document.getElementById("your-answer");
    yourAnswer.textContent = "";
    document
        .querySelectorAll("#word-buttons .choice-btn")
        .forEach((btn) => (btn.disabled = false));
}
function moveWord(btn, toContainer, fromContainer) {
    const clone = btn.cloneNode(true);
    clone.addEventListener("click", () =>
        moveWord(clone, fromContainer, toContainer)
    );
    fromContainer.removeChild(btn);
    toContainer.appendChild(clone);
}
function clearReorderAnswer() {
    const answerContainer = document.getElementById("your-answer");
    const wordContainer = document.getElementById("word-buttons");
    const buttons = [...answerContainer.querySelectorAll("button")];
    buttons.forEach((btn) => {
        answerContainer.removeChild(btn);
        wordContainer.appendChild(btn);
        btn.addEventListener("click", () =>
            moveWord(btn, answerContainer, wordContainer)
        );
    });
}

// Sự kiện
document.getElementById("submit-btn").addEventListener("click", checkAnswer);
document.getElementById("closeBtn").addEventListener("click", () => {
    document.getElementById("popup-wrapper").classList.add("hidden");
});

document.addEventListener("DOMContentLoaded", () => {
    const closeBtn = document.getElementById("complete-close");
    if (closeBtn) {
        closeBtn.addEventListener("click", () => {
            document.getElementById("complete-popup").classList.add("hidden");
        });
    }
});

function generateColorDots() {
    const container = document.querySelector(".color-dots");
    const colors = ["#ff6b6b", "#feca57", "#48dbfb", "#1dd1a1", "#5f27cd"];
    for (let i = 0; i < 30; i++) {
        const dot = document.createElement("div");
        const size = Math.random() * 10 + 6;
        dot.classList.add("dot");
        dot.style.width = `${size}px`;
        dot.style.height = `${size}px`;
        dot.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];
        dot.style.top = `${Math.random() * 100}%`;
        dot.style.left = `${Math.random() * 100}%`;
        dot.style.animationDelay = `${Math.random() * 5}s`;
        dot.style.animationDuration = `${5 + Math.random() * 5}s`;
        container.appendChild(dot);
    }
}
generateColorDots();

function showReplayConfirm(onYes) {
    const popup = document.getElementById("confirm-popup");
    popup.classList.remove("hidden");

    const yesBtn = document.getElementById("confirm-yes");
    const noBtn = document.getElementById("confirm-no");

    yesBtn.replaceWith(yesBtn.cloneNode(true));
    noBtn.replaceWith(noBtn.cloneNode(true));

    const newYes = document.getElementById("confirm-yes");
    const newNo = document.getElementById("confirm-no");

    newYes.addEventListener("click", () => {
        popup.classList.add("hidden");
        onYes();
    });

    newNo.addEventListener("click", () => {
        popup.classList.add("hidden");
    });
}

function launchConfetti() {
    const duration = 2 * 1000;
    const animationEnd = Date.now() + duration;
    const defaults = {
        startVelocity: 30,
        spread: 360,
        ticks: 60,
        zIndex: 10001,
    };

    function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
    }

    const interval = setInterval(function () {
        const timeLeft = animationEnd - Date.now();

        if (timeLeft <= 0) {
            return clearInterval(interval);
        }

        const particleCount = 50 * (timeLeft / duration);

        confetti(
            Object.assign({}, defaults, {
                particleCount,
                origin: {
                    x: randomInRange(0.1, 0.9),
                    y: Math.random() - 0.2,
                },
            })
        );
    }, 250);
}
function saveProgress(chapterName) {
    fetch("../api/save_progress.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            chapter: chapterName,
        }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                console.log("Đã lưu tiến độ:", chapterName);
            } else {
                console.error("Lỗi khi lưu tiến độ");
            }
        })
        .catch((error) => {
            console.error("Lỗi kết nối:", error);
        });
}
window.addEventListener("DOMContentLoaded", () => {
    fetch("../api/get_progress.php")
        .then((res) => res.json())
        .then((data) => {
            if (data.success) {
                const progress = data.progress;
                let firstUndone = null;

                for (let i = 1; i <= 10; i++) {
                    const btn = document.getElementById("chapter" + i);
                    if (progress["chapter" + i] == 1) {
                        btn.classList.add("done");
                    } else if (!firstUndone) {
                        firstUndone = btn;
                    }
                }

                // Gắn chương tiếp theo (first chưa hoàn thành)
                if (firstUndone) {
                    firstUndone.classList.add("now-chapter");
                }
            } else {
                console.error("Không lấy được tiến độ:", data.error);
            }
        })
        .catch((err) => {
            console.error("Lỗi kết nối API tiến độ:", err);
        });
});
function moveNowToCurrentChapter() {
    const now = document.getElementById("now");
    const nowChapterBtn = document.querySelector(".inner-button.now-chapter");

    if (!now || !nowChapterBtn) return;

    const btnRect = nowChapterBtn.getBoundingClientRect();
    const containerRect = document
        .querySelector(".button-container")
        .getBoundingClientRect();

    const newLeft =
        btnRect.left -
        containerRect.left +
        nowChapterBtn.offsetWidth / 2 -
        now.offsetWidth / 2;
    const newTop = btnRect.top - containerRect.top - 40;

    now.style.left = `${newLeft}px`;
    now.style.top = `${newTop}px`;
}
